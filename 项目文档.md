# AI 自学辅助工具 — 项目实现需求文档

> 版本：1.0

---

## 一、项目概述

本项目目标是实现一款面向个人学习者/研究者的**AI 自学辅助工具**，核心为一个无边际（无限画布）编辑区和基于节点树的知识构建系统，深度集成大语言模型（LLM）与联网检索能力，支持可运行代码片段、可视化（Mermaid、SVG、图结构等）、交互式动画生成与自定义思维导图编辑。该文档完整列出功能需求、UI 行为、数据格式、交互流程、后端与安全要求、测试与验收标准，禁止遗漏用户需求中任何细节。

---

## 二、总体目标与主要功能一览

1. **主界面（全屏）**：中央为无边际编辑区，支持无限拖动与缩放（平移/缩放/多级缩放），左下角有用户头像按钮（点击进入设置界面，全屏），右侧有抽屉栏（默认隐藏，可通过按钮拉出）
2. **抽屉栏**：AI 对话界面，可在任意界面唤出，LM 提示包含当前界面内容 + 相关节点树
3. **节点树（树状结构）**：节点为方形，显示主题与摘要；节点上下边缘有连接点；方形一侧（约定为右侧）有若干**纯图形（SVG）按钮**：收藏，重新生成，删除，联想推荐
4. **联想推荐**：点击后弹出界面显示 LLM 根据当前节点主题联想推荐的多个知识点关键词，用户可多选并确认，系统将创建新的子节点并与原节点连接
5. **边（Edge）**：在连接点（顶部/底部）进行连接，支持多条边
6. **节点构建流程与内容编辑**：右键无边际区域 -> 添加 -> 弹窗输入主题 -> 生成（AI 根据主题生成摘要与教程文章，格式为 Markdown）-> 节点上显示白色遮罩展示生成进度 -> 完成后节点显示主题与摘要（默认不自动跳转到内容界面）-> 单击节点进入节点内容界面
7. **节点内容界面**：左侧为导航目录（从 Markdown 自动生成，支持点击跳转），右侧为内容浏览（Markdown 渲染），支持解析模型生成的代码段标记（可运行 html、python、java、c++），显示 Mermaid、图结构、SVG 等
8. **文本选择工具栏**：在内容界面选中文本会弹出一个**横向分布的图形按钮栏（全部为 SVG 图形，无文字）**，包含：高亮、批注、收藏、添加到对话（唤出右侧栏并把划出部分添加到对话）、生成动画（LLM 生成交互式动画网页 HTML 并保存到内容中）、拓展生成（基于选中部分创建新子节点并连接）等
9. **思维导图生成与编辑**：内容预览界面左上靠目录区域处有一个图标按钮（不与目录重叠），点击调用 LLM，根据当前节点全部内容生成思维导图（生成完成默认不跳转）。生成完毕后再次点击该按钮会唤出思维导图界面（约占总界面大小的 1/4），不影响目录与内容正常阅读，且支持用户直接编辑思维导图
10. **主题/风格**：所有图形按钮使用 SVG 图标，界面支持黑/白两种风格切换
11. **LLM 生成策略**：所有 LLM 生成操作在发出请求前必须包含联网搜索；LLM 的提示词内必须包含当前界面内容 + 相关节点树
12. **数据持久化**：完整数据以节点树形式保存：每个节点包含主题、摘要、目录结构、详细内容、标记/批注/收藏/动画等、思维导图（如果有）

---

## 三、详细功能需求

### 3.1 主界面（无边际编辑区）

#### 3.1.1 画布行为

* 画布为**无限平移/无限缩放**（无边界感）：支持鼠标拖拽平移（空格+拖拽或中键拖拽），滚轮/触控板缩放（鼠标滚轮或触控缩放），支持触摸手势（双指拖动/捏合缩放）
* 支持平移/缩放惯性、缩放中心为鼠标指针位置
* 支持网格与对齐建议（可选），节点拖动时显示连线建议
* 性能要求：当节点数（含边）达到中等规模（>200）时仍保持流畅，采用视图裁剪（culling）与分层渲染

#### 3.1.2 左下角用户头像按钮

* 固定左下角，点击切换到**设置界面（全屏）**，设置界面包括：账户/API Key 配置、模型设置、隐私与同步设置、主题切换、导出/导入、帮助

#### 3.1.3 右侧抽屉栏按钮

* 右侧隐藏抽屉：默认不显示，仅显示一个可点击的浮动按钮（例如页面右中位置）或者可配置位置的触发控件；点击后抽屉滑出覆盖右侧（响应式：移动端为全屏抽屉）
* 抽屉可以通过 ESC 或再次点击触发按钮关闭

### 3.2 抽屉栏（AI 对话界面）

#### 3.2.1 可唤出范围

* 抽屉栏能在任意界面（无边际主界面、节点内容界面、设置界面）被唤出

#### 3.2.2 内容与提示词要求

* 每次对话（或生成请求）发送给 LLM 的 prompt 必须包含：

  * 当前界面的可见内容（例如：当前节点的主题、摘要、目录与正在浏览或选中的章节文本）
  * 与该节点相关的节点树片段（父节点、同级节点、子节点的主题与摘要）
  * 检索到的联网搜索结果摘要（LLM 请求前需先进行检索）

#### 3.2.3 UI 要求

* 聊天 UI 支持：消息气泡、代码块高亮、可点击生成的链接/节点建议、历史对话搜索
* 聊天消息可被绑定到节点（将聊天片段保存为与某节点关联的注释）

### 3.3 节点（Node）与边（Edge）

#### 3.3.1 节点样式

* 节点为**方形**卡片，显示两行主要信息：主题（title）与摘要（summary，短文本）
* 节点的上下边缘（Top / Bottom）**必须有连接点**（可视化小圆点或锚点），用户可以从这些点拖出边
* 节点的右侧竖列放置 4 个纯 SVG 图形按钮（无文字）：收藏、重新生成（regenerate）、删除、联想推荐（idea）
* 节点顶部可显示状态徽章（如：生成中、离线、已完成）
* 节点处于生成中时，显示**白色遮罩层**覆盖方形并显示进度条／进度百分比（必须是白色半透明遮罩）

#### 3.3.2 节点交互

* **单击**：进入该节点的内容界面
* **右键**：弹出节点上下文菜单（编辑、复制、导出、创建子节点、创建边、删除、重命名等）
* **拖拽**：移动节点位置；拖动时若拖到画布边界向外继续拖动，画布自动扩展
* **从连接点拖动到另一节点的连接点**：创建边，连接点对齐，并在边上显示端点箭头（可配置方向）
* **节点右侧按钮功能**：

  * 收藏：将节点标为收藏
  * 重新生成：触发 LLM 重新生成该节点的摘要与内容（遵循生成流程，显示生成遮罩）
  * 删除：删除节点及相关边（确认弹窗）
  * 联想推荐：弹出 modal（或侧边弹层）显示由 LLM 基于“当前节点主题 + 节点树片段 + 联网检索结果”生成的若干关键词建议，用户可勾选若干关键词并确认，系统将为每个已选关键词创建新节点（作为子节点）并自动连接到原节点；新节点在创建时走正常生成流程并显示生成进度

#### 3.3.3 边（Edge）

* 边仅能在连接点上连接节点的上下边缘连接点
* 支持单向或双向（可选）显示
* 边可被选中并编辑（例如：标注类型、笔记、权重、断开/重连）

### 3.4 节点树构建完整流程（详述）

1. **用户操作**：在无边际区域右键 -> 选择『添加』。
2. **弹窗**：弹出小窗口（模态），用户输入**节点主题**，提供可选参数：父节点（默认为画布根或所选节点）、标签、优先级、公开/私有标记。
3. **生成**：用户点击『生成』后：

   * 客户端先进行联网搜索（基于主题短语检索多条结果），将检索摘要与链接保存在请求上下文
   * 构造 prompt => 包含：用户输入主题、检索摘要、当前节点树片段（若存在父节点/兄弟/被选节点）、用户偏好（写作风格、语言、长度）
   * 发送 LLM 请求（建议启用流式响应）并在节点上显示**白色遮罩层**展示生成进度（使用 stream token/percentage 或估算进度）
   * LLM 返回：节点摘要（短）、以及完整的教程文章（Markdown 格式）——包含目录、代码段、示例、参考链接
   * 客户端解析返回，填充节点的摘要字段与完整内容字段，遮罩移除（完成状态显示）
4. **默认行为**：生成完毕后**不自动打开**节点内容界面；只在节点上显示主题/摘要，用户可手动单击进入

### 3.5 节点内容界面（详细）

#### 3.5.1 布局

* 全屏：左侧栏为导航目录（由 Markdown 结构自动生成），目录支持折叠与点击跳转
* 中央／右侧为内容浏览区，渲染 Markdown（支持代码高亮、表格、数学公式、交互式嵌入）
* 内容区支持内嵌组件（如下）：

  * 可运行代码段（标签/标识需被模型/系统解析，如：`run:html`、`run:python`、`run:java`、`run:cpp`）
  * Mermaid 图（自动渲染），图结构（可交互放大/缩小），SVG 直接嵌入并可编辑
  * 交互式动画组件（生成自 LLM 的 HTML 文件并内嵌/引用）

#### 3.5.2 代码段与可运行环境

* 客户端需能识别并渲染下列代码标记：HTML、Python、Java、C++；支持 Merlin/标注风格或自定义的 code-block 元数据（例如：` `run:python {stdin:..., args:...}```）
* **运行策略（安全与实现选项）**：

  * **首选**：使用后端受限容器或沙箱服务（短时容器、WebAssembly、或专用执行微服务）执行用户请求代码，返回 stdout/stderr、渲染结果、截图或 HTML 片段
  * **替代/受限**：对于不可在后端运行的环境（例如需要底层系统资源的 C++ 大型编译），提供代码下载与本地运行说明，或通过远端编译服务（需用户授权）
* **安全措施**：严格沙箱、网络访问限制、资源/时间配额、文件系统隔离、审计日志、用户确认提示
* **渲染**：HTML 代码段可以直接在沙箱 iframe 中渲染；Python 可在受限后端内执行并返回文本/图像/图表；Mermaid 使用客户端库渲染为 SVG

#### 3.5.3 文本选择与横向图形工具栏

* 用户在内容界面划词/选中文本时，自动弹出**横向分布**的图形按钮栏（浮动、贴近所选文本，布局参考输入法按钮形式）：

  * 图标项（示例列表，仅图形无文字）：高亮、批注（添加注释/作者/时间）、收藏、添加到对话（点击则唤出右侧抽屉栏并把选中文本作为消息内容插入对话框中）、生成动画（触发 LLM 生成一个交互式动画网页 HTML 并将其保存在当前节点内容中）、拓展生成（基于选中内容创建新节点并作为子节点与当前节点连接）
* 工具栏图标均为 SVG，鼠标悬浮显示简短 tooltip（仅在设置允许时，tooltip 为辅助性文本，不替代图标）

#### 3.5.4 思维导图按钮与流程

* 在内容预览界面**左上角靠近目录界面部分（目录左侧，上方，不与目录重叠）**放置一个图标按钮（SVG）
* **第一次点击**：调用 LLM（同样先检索）以当前节点的全部内容作为输入，生成思维导图数据（图的节点、层级关系、简短摘要）并保存（但不自动切换视图）
* **生成完成后**：再次点击该按钮会唤出思维导图界面，约占主界面的 1/4（右或左侧可配置），该界面可与主界面并存，不遮挡目录与内容，并支持：

  * 直接拖拽、编辑节点文本、增加/删除节点、改变连线关系
  * 编辑后可以再次保存到该节点的思维导图字段

### 3.6 样式与图标

* **图形按钮**全部采用 SVG 文件（或内联 SVG），禁止使用特殊符号或文字作为图标
* 全界面支持**黑/白主题（深色/浅色）**切换，且所有 UI 元素、SVG 图标在两套样式下保持可辨识性
* 字体、间距需保证可读性（建议最小字体 13px），支持高对比模式

### 3.7 LLM 与联网检索策略

* 在任何需要 LLM 生成的操作**必须**先进行联网检索（可配置为使用默认检索引擎或用户指定的检索服务）
* LLM prompt **必须包含**：当前界面/节点可见文本片段、节点树相关上下文（父/子/同级的主题与摘要）、联网检索摘要
* 支持**流式**生成（streaming）：客户端在收到流式 token 时更新节点的白色遮罩进度指示（若无法精确计算百分比，可显示滚动进度与文字状态）
* 需设计 prompt 模板并提供可配置参数（语言、长度、样式、引用格式）

### 3.8 数据模型与持久化（必须支持的字段）

#### 3.8.1 节点树总体结构（JSON 表示示例）

````
{
  "nodes": [
    {
      "id": "uuid-1",
      "parent_id": null,
      "theme": "节点主题",
      "summary": "自动生成的摘要",
      "toc": [ {"level":1, "text":"...", "anchor":"h1-1"}, ... ],
      "content_md": "# 标题\n内容...\n```run:python\nprint(\"hi\")\n```",
      "annotations": [ {"id":"a1","range":{...},"text":"注释内容","author":"user","ts":"..."} ],
      "favorites": true/false,
      "animations": [ {"id":"anim1","file_path":"/media/anim1.html","meta":{...}} ],
      "mindmap": { /* 可选，序列化的思维导图结构 */ },
      "metadata": {"created_at":"...","updated_at":"...","version": 3}
    },
    ...
  ],
  "edges": [ {"id":"e1","from_node":"uuid-1","from_anchor":"bottom","to_node":"uuid-2","to_anchor":"top","meta":{...}}, ... ]
}
````

#### 3.8.2 必须持久化的项目

* 节点：id、父/子关系、主题、摘要、TOC、content_md、注释/标记/收藏、动画资产引用、思维导图数据、元数据（创建/修改时间、版本）
* 边：id、起点节点 id、终点节点 id、起止 anchor（top/bottom）、meta
* 用户设置：主题（白/黑）、API keys、模型选择、检索设置、同步设置

#### 3.8.3 存储方案

* **客户端持久化**：使用 IndexedDB 本地缓存（离线可读），并定期自动保存草稿
* **服务端持久化**：REST/GraphQL API 存储到关系型或文档型数据库（建议：Postgres / MongoDB）
* **导出/导入**：支持导出为 JSON（节点树），Markdown（单节点或选中节点导出），OPML（大纲互操作），GraphML（图结构），以及导出思维导图为 SVG / PNG；支持从这些格式导入
* **版本/历史**：为每个节点保存历史版本（至少最近 50 个版本或 30 天内），支持回滚
* **同步/协作（可选）**：通过 WebSocket / CRDT 实现实时协作（需在规范中列明冲突合并策略）

### 3.9 安全、隐私与合规

* **执行代码安全**：所有可执行代码必须运行在受限沙箱中；不允许直接访问主机文件系统或内部网络；网络访问须受限或经用户确认
* **数据传输**：TLS/HTTPS
* **敏感数据**：允许用户选择在发送给 LLM 前去除个人敏感信息（或采用本地隐私过滤）
* **数据加密**：服务器端可选对数据静态加密（AES-256）并对备份加密
* **日志与审计**：执行代码日志、LLM 调用日志需可审计，且敏感内容需按策略掩码
* **合规**：可配置数据区域（如选择区域化存储）以满足法律要求

### 3.10 离线/降级策略

* 当网络不可用时，允许用户在本地继续浏览/编辑已缓存节点，但**LLM 生成**与**联网检索**功能不可用或提示用户开启联网
* 提供**离线模式提示**与任务队列，一旦网络恢复可以自动或手动重试生成请求

---

## 四、交互细节（UX 细节清单）

* 节点生成时**必须**显示白色遮罩用于展示生成进度（不可用其他颜色），并在生成失败时提供重试与查看错误日志按钮
* 节点上的四个图形按钮必须无文字，仅靠 SVG 图形辨识；鼠标悬浮根据设置可显示 tooltip
* 联想推荐界面必须展示 LLM 建议的关键词清单，允许多选并显示每个建议的简短理由/来源摘要
* 内容选择栏（划词弹出）是**横向分布**的图形按钮栏，摆放方向水平且紧靠选区
* 思维导图按钮位置：内容预览界面左上靠目录区域（目录左侧、上方，且不与目录重叠）
* 思维导图面板默认大小约为主界面的 1/4，可停靠或浮动
* 抽屉栏聊天必须能接收从文本选择的片段并自动作为消息填充到输入框
* 所有生成动作（节点/联想/导图/动画/重新生成）在 prompt 里都必须把“当前界面内容 + 相关节点树 + 检索结果”作为上下文

---

## 五、技术实现建议（非强制，但建议遵循）

### 前端

* 框架：React + TypeScript
* Canvas 渲染：使用基于 WebGL 的渲染库（例如 PixiJS、Konva 的 WebGL 分支，或自研基于 Canvas2D + requestAnimationFrame 的层级渲染）以保证大量节点时的性能
* Markdown 渲染：remark/rehype 生态（支持自定义 code block 解析）
* Mermaid：使用 mermaid.js 客户端渲染
* 可运行代码 UI：iframe 沙箱 + 后端执行 API
* 存储：IndexedDB（localforage）+ 后端同步

### 后端

* API：REST 或 GraphQL
* LLM 服务对接：支持 OpenAI / Azure / 私有 LLM；使用流式 API 并将检索结果作为额外上下文
* 检索：集成可配置的检索组件（例如 ElasticSearch / Bing/Web 検索 API / Google Custom Search），生成请求前必须检索并把摘要放入 prompt
* 代码执行沙箱：容器化执行服务（短时容器或 WASM）并严格限额

### 持续集成与部署

* 自动化测试（单元/集成/E2E）、代码质量（lint、typecheck）、依赖扫描
* 使用 CI/CD 部署前端静态资源与后端服务

---

## 六、数据格式与示例（JSON schema 概览）

（见上文 3.8.1 示例；在实现阶段须细化为 JSON Schema 文档，包含字段类型、最大长度及约束）

---

## 七、权限、配置与用户设置

* 用户可在设置界面配置：LLM 提供者与 API Key、检索引擎/API Key、默认生成偏好（语言、段落长度、样式）、导出偏好、隐私/分享设置
* 用户可设置是否允许自动联网检索（若关闭则 LLM 将不含检索结果）

---

## 八、测试与验收标准（Acceptance Criteria）

1. 主界面加载后能在 2s 内响应第一笔交互（点击/拖拽）于常见中小规模数据集（<=200 节点）
2. 节点生成流程：用户右键->添加->输入主题->生成，LLM 返回并在节点上展示白色遮罩进度，生成完成后节点显示摘要且不自动打开内容界面
3. 单击节点进入内容界面，目录由 Markdown 自动生成并支持点击跳转
4. 内容选中文本时会弹出横向图形工具栏，且“添加到对话”会唤出右侧抽屉并填充选中文本
5. 联想推荐弹层显示由 LLM 生成的关键词，用户多选并确认后，新的子节点被创建并与父节点连线
6. 支持 Mermaid 渲染、SVG 嵌入与可运行 HTML（在安全沙箱中）
7. 所有 LLM 生成均在请求前做联网检索，且 prompt 包含当前界面内容与节点树片段
8. 数据能导出为 JSON 与 Markdown，且导出的 JSON 能完整重建节点树（主题、摘要、内容、注释、动画、思维导图）

---

## 九、交付物与里程碑（示例）

* M0：需求评审与原型（本文件）
* M1：核心画布与节点数据模型实现（支持添加/移动/连接/删除）
* M2：节点生成流程（含联网检索、LLM 对接、生成进度遮罩）
* M3：节点内容界面（Markdown 渲染、目录、选择工具栏、Mermaid/SVG）
* M4：可运行代码片段沙箱（HTML 渲染 + Python 基础执行）
* M5：联想推荐、思维导图生成与编辑、抽屉聊天集成
* M6：导出/导入、版本历史、设置界面、主题切换
* M7：测试、性能调优、安全审计、发布

---

## 十、示例 Prompt 模板（供实现时参考）

````
任务：根据下面信息生成节点摘要与完整教程（Markdown）。

上下文：
- 用户输入主题：{{theme}}
- 当前界面可见内容（若有）：{{visible_text_snippet}}
- 相关节点树片段（父/子/同级）：{{node_tree_fragment}}
- 检索摘要（来自联网检索）：
  - {{search_result_1_title}}: {{search_result_1_snippet}}
  - ...

要求：
- 输出 JSON：{"summary":"...","content_md":"# ..."}
- content_md 使用 Markdown 格式，包含目录（自动生成的 H2/H3 节点），代码块请尽量使用标注（例如 ```run:python）来标识可执行代码
- 语言：{{language}}
- 长度：建议 800-2000 字；若用户设置了短摘要则相应调整
````

---

## 十一、登录/注册/用户数据库系统计划（结合当前项目）

### 11.1 当前现状（基于代码库）

* 前端：Vite + React + Zustand + localforage（IndexedDB），当前项目/节点/边等数据以本地持久化为主（见 [appStore.ts](file:///Users/darkspace/Downloads/Projects/Cursor-test/nexlearn/src/stores/appStore.ts)），`Project.userId` 目前写死为 `'user-1'`（已留 TODO）。
* 后端：Express + TypeScript，当前提供 LLM/检索/聊天/动画等能力（`/api/v1/*`），不包含账号体系、会话管理与数据库持久化（见 [backend/src/index.ts](file:///Users/darkspace/Downloads/Projects/Cursor-test/nexlearn/backend/src/index.ts) 与 [backend/src/routes](file:///Users/darkspace/Downloads/Projects/Cursor-test/nexlearn/backend/src/routes)）。
* 跨域：后端已开启 `credentials: true` 的 CORS，但前端 `fetch` 当前未统一开启 `credentials: 'include'`（见 [api.ts](file:///Users/darkspace/Downloads/Projects/Cursor-test/nexlearn/src/lib/api.ts)），后续若采用 Cookie 会话需要配套调整。

### 11.2 目标与范围（分阶段）

* **MVP（账号可用）**：注册/登录/登出/获取当前用户，后端具备用户表与密码安全存储；前端有最小化登录 UI，能在已登录状态下展示用户信息。
* **MVP+（数据可同步）**：项目（Project）从“本地为主”演进到“本地+云端同步”：支持上传/下载、增量同步与冲突策略（先最简单：整包上传/下载）。
* **后续（多设备/协作）**：多端同步优化、版本历史、分享权限、协作（可选）。

### 11.3 技术选型建议（贴合现有 Express）

#### 认证与会话

* **首选方案：Cookie + 会话（Session）**
  - 服务端存 session（Redis 或数据库表），浏览器用 `HttpOnly` Cookie 保存 session id
  - 优点：实现直观、撤销会话容易、适合 Web App
  - 注意：需要 CSRF 防护（同站 Cookie + CSRF token 或双重提交）
* **备选方案：JWT（短 access）+ Refresh Token（长 refresh，HttpOnly Cookie）**
  - access 用于 API 鉴权，refresh 用于续期与撤销
  - 优点：更适合将来拆分服务/多客户端
  - 注意：refresh 必须可撤销（表里存 token 哈希或 jti），并完善轮换策略

#### 数据库

* 推荐：**PostgreSQL**（对关系数据、约束、事务更友好）
* ORM/迁移：优先 **Prisma**（生态成熟、迁移清晰）；也可选 Drizzle（更轻量）
* 本地开发：Docker Compose 起 Postgres（后续落地时再补齐）

### 11.4 后端 API 规划（v1）

#### Auth

* `POST /api/v1/auth/register`
  - 入参：`email`/`password`/`displayName`（可选）
  - 出参：用户基础信息（不含敏感字段）
* `POST /api/v1/auth/login`
  - 入参：`email`/`password`
  - 出参：用户基础信息 +（若是 cookie session 则仅 set-cookie）
* `POST /api/v1/auth/logout`
  - 行为：销毁会话/撤销 refresh
* `GET /api/v1/auth/me`
  - 行为：返回当前登录用户

#### Projects（先为“同步”预留）

* `GET /api/v1/projects`：列出当前用户的项目
* `POST /api/v1/projects`：创建项目
* `GET /api/v1/projects/:id`：获取项目（包含 nodes/edges 或引用）
* `PUT /api/v1/projects/:id`：更新项目（先支持整包上传；后续再做增量）

### 11.5 数据库表设计草案（MVP → 同步）

#### users（MVP 必需）

* `id`（uuid）
* `email`（唯一）
* `password_hash`（bcrypt/argon2）
* `display_name`（可选）
* `created_at` / `updated_at`

#### auth_sessions（若采用 session/refresh）

* `id`（uuid）
* `user_id`
* `token_hash` 或 `session_id`
* `created_at` / `expires_at` / `revoked_at`
* `ip` / `user_agent`（可选，风控与审计）

#### projects（同步阶段）

* `id`（uuid）
* `user_id`
* `name`
* `data_json`（先整包存储：nodes/edges/settings；后续拆表优化）
* `version`（整数自增，用于乐观锁/冲突检测）
* `created_at` / `updated_at`

### 11.6 前端改造点（MVP）

* 引入 `authStore`（或扩展现有 `appStore`）管理：`currentUser`、登录态初始化、登出
* `UserAvatar`/设置页补齐：未登录显示“登录/注册”，已登录显示头像与账号入口
* API 请求层支持 cookie：统一在 `fetch` 中开启 `credentials: 'include'`（若采用 cookie 会话）
* 把 `Project.userId: 'user-1'` 替换为 `currentUser.id`，并在未登录时走“本地模式”（可选：游客模式）

### 11.7 安全策略（必须项）

* 密码：使用强哈希（bcrypt/argon2），加盐；注册/登录加限流（IP + 账号维度）
* 会话：HttpOnly + Secure（生产环境）+ SameSite（Lax/Strict 结合业务选择）
* CSRF：若使用 cookie 鉴权，必须做 CSRF 防护
* 日志：禁止记录密码/令牌/敏感 Cookie；对 OpenAI key 等环境变量严禁写入日志
* 权限：所有用户数据接口必须校验“资源归属”（user_id）

### 11.8 部署到 GitHub + 服务器（CI/CD 计划）

> 这里的“GitHub server”按“使用 GitHub Actions 持续集成，并自动部署到一台服务器/VPS”来规划。

* **推荐形态**
  - 前端：静态构建产物（Vite build）由 Nginx/静态服务托管
  - 后端：Node 容器化运行（Docker），对外仅暴露 API 端口
  - 数据库：Postgres（同机容器或托管服务）
* **GitHub Actions 流程（概要）**
  - PR：跑 `lint/type-check/test`（前后端各自一套）
  - main：构建镜像推送到 GHCR（GitHub Container Registry），服务器拉取并滚动重启
  - 机密：通过 GitHub Secrets 管理（DB 连接串、OpenAI key、JWT secret 等），不写入仓库
* **配置要点**
  - 后端 CORS `FRONTEND_URL` 配置生产域名
  - HTTPS：建议 Nginx/Traefik 终止 TLS（Let’s Encrypt）
  - 运行时日志：集中到服务器日志或外部日志系统（最小化敏感信息）

### 11.9 里程碑拆分（建议）

* A0：确定认证方案（session vs JWT-refresh）与数据库（Postgres）
* A1：后端实现 auth API + 用户表 + 基础安全（限流、密码策略、CSRF 方案定型）
* A2：前端接入登录/注册/登出与登录态恢复
* A3：项目同步 MVP（整包上传/下载 + 版本号冲突提示）
* A4：CI/CD（GitHub Actions）打通：测试、构建、部署到服务器

---

## 十二、注意事项与风险

* LLM 与联网检索带来的延迟应通过流式与前端友好进度指示来缓解
* 可执行代码带来安全风险，必须保证沙箱和权限管理
* 大规模节点时的渲染性能需提前验证并引入分页/裁剪/分层渲染
* 隐私合规（尤其是将用户内容带入联网检索或 LLM 时）需明确告知并提供控制

**重要实施提醒**：在实现过程中，任何需求未明确的点都应立即提问用户以获取确认，避免开发时的假设和返工。

---

## 十三、后续扩展建议（可选）

* 引入多人实时协作（CRDT）与评论线程
* 提供社区知识集成/模板市场（用户共享节点模板或教程）
* 离线 LLM 支持（本地私有模型）以提高隐私性

---

**结束语**：本需求文档为面向开发团队与产品团队的实现蓝图，已尽量覆盖用户提出的所有细节性要求：主界面行为、抽屉栏、节点与联想推荐、节点生成流程、内容界面细节、可执行代码支持、思维导图生成与编辑、SVG 图标与主题切换、LLM+检索策略、数据模型与持久化、安全与测试标准等。后续可基于此拆分技术任务、制作交互原型并推进实现。
